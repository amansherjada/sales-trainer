<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>American Hairline - Methodology Trainer</title>
    <script>
        // Suppress Tailwind CDN production warning
        window.process = { env: { NODE_ENV: 'development' } };
        window.tailwind = { config: { corePlugins: { preflight: false } } };
    </script>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography,aspect-ratio,line-clamp"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-bubble {
            max-width: 75%;
            padding: 12px 16px;
            border-radius: 16px;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateY(10px);
            animation: popIn 0.3s forwards;
        }
        @keyframes popIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .chat-bubble-user {
            background-color: #3b82f6;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .chat-bubble-ai {
            background-color: #e5e7eb;
            color: #1f2937;
            border-bottom-left-radius: 4px;
        }
        .report-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            color: #111827;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.5rem;
        }
        .report-section ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            color: #374151;
        }
        .report-section li {
            margin-bottom: 0.5rem;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .score {
            font-weight: 700;
            color: #2563eb;
        }
        #difficulty-info {
            transition: background-color 0.3s ease;
        }
        .api-key-input {
            border: 2px solid #e5e7eb;
            transition: border-color 0.3s ease;
        }
        .api-key-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .api-key-valid {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        .api-key-invalid {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="w-full max-w-6xl mx-auto bg-white shadow-2xl rounded-lg overflow-hidden" style="min-height: 95vh;">
        <header class="gradient-bg text-white p-6 shadow-md">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold">American Hairline Sales Trainer</h1>
                    <p class="text-blue-100 mt-1">Methodology: American Hairline</p>
                </div>
                <div id="status-indicator" class="flex items-center space-x-2">
                    <div class="w-3 h-3 rounded-full bg-gray-300 animate-pulse"></div>
                    <span class="text-blue-100 text-sm font-medium">Initializing</span>
                </div>
            </div>
        </header>

        <main id="main-content">
            <div id="config-panel" class="p-8">
                <!-- API Key Configuration Section -->
                <div class="bg-white p-6 rounded-lg shadow-md border mb-8">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">API Configuration</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="api-key-input" class="block text-sm font-medium text-gray-700 mb-2">
                                OpenRouter API Key
                                <span class="text-red-500">*</span>
                            </label>
                            <input 
                                type="password" 
                                id="api-key-input" 
                                placeholder="Enter your OpenRouter API key (sk-or-v1-...)" 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent api-key-input"
                            >
                            <div class="mt-2 text-xs text-gray-600">
                                Get your API key from <a href="https://openrouter.ai" target="_blank" class="text-blue-600 underline">openrouter.ai</a>
                            </div>
                        </div>
                        <div>
                            <label for="openai-api-key-input" class="block text-sm font-medium text-gray-700 mb-2">
                                OpenAI API Key (for embeddings)
                                <span class="text-red-500">*</span>
                            </label>
                            <input 
                                type="password" 
                                id="openai-api-key-input" 
                                placeholder="Enter your OpenAI API key (sk-...)" 
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent api-key-input"
                            >
                            <div class="mt-2 text-xs text-gray-600">
                                Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank" class="text-blue-600 underline">OpenAI Platform</a>
                            </div>
                        </div>
                        <div id="api-key-status" class="mt-2 text-sm hidden"></div>
                        <button id="test-api-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400">
                            Test API Connection
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-md border card-hover">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">1. Select Product/Service</h3>
                        <select id="product-category" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="hair-replacement-systems">Hair Replacement Systems</option>
                            <option value="attachment-methods">Attachment Methods</option>
                            <option value="hair-transplant">Hair Transplant Services</option>
                            <option value="scalp-micro-pigmentation">Scalp Micro Pigmentation (SMP)</option>
                            <option value="customization-services">U.N.L. 21 Custom Systems</option>
                            <option value="maintenance-services">Maintenance Services</option>
                            <option value="consultation-services">Consultation Services</option>
                        </select>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md border card-hover">
                        <h3 class="text-lg font-semibold mb-4 text-gray-800">2. Difficulty Level</h3>
                        <select id="difficulty-level" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="new-joining">New joining</option>
                            <option value="basic" selected>Basic</option>
                            <option value="experienced">Experienced</option>
                            <option value="expert">Expert</option>
                        </select>
                        <div id="difficulty-info" class="mt-3 p-2 bg-gray-50 border rounded-md"></div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-lg shadow-md border mb-8">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">3. Session Settings</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="salesperson-name" class="block text-sm font-medium text-gray-700 mb-2">Salesperson Name</label>
                            <input type="text" id="salesperson-name" placeholder="Enter your name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label for="session-duration" class="block text-sm font-medium text-gray-700 mb-2">Session Duration (minutes)</label>
                            <select id="session-duration" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="5">5 minutes</option>
                                <option value="10" selected>10 minutes</option>
                                <option value="15">15 minutes</option>
                                <option value="20">20 minutes</option>
                                <option value="25">25 minutes</option>
                                <option value="30">30 minutes</option>
                            </select>
                        </div>
                        <div>
                            <label for="thinking-time" class="block text-sm font-medium text-gray-700 mb-2">Thinking Time (seconds)</label>
                            <select id="thinking-time" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="2000">2 seconds</option>
                                <option value="3000" selected>3 seconds</option>
                                <option value="4000">4 seconds</option>
                                <option value="5000">5 seconds</option>
                                <option value="7000">7 seconds</option>
                                <option value="10000">10 seconds</option>
                                <option value="15000">15 seconds</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-sm text-blue-800">
                            <span class="font-bold">Important:</span> Make sure to <span class="font-semibold">allow microphone access</span> in your browser when prompted. This application works best on Google Chrome or Microsoft Edge.
                        </p>
                    </div>
                </div>

                <div class="flex justify-center">
                    <button id="start-btn" class="px-8 py-4 bg-blue-600 text-white font-bold text-lg rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-all transform hover:scale-105 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                        üöÄ Start Training Session
                    </button>
                </div>
            </div>

            <div id="training-area" class="hidden p-6 md:p-8">
                <div class="bg-white p-4 rounded-lg shadow-md border mb-6">
                    <div class="flex flex-wrap justify-between items-center gap-4">
                        <div class="flex items-center space-x-4">
                            <span class="text-sm font-medium text-gray-600">Session Timer:</span>
                            <span id="session-timer" class="text-xl font-bold text-blue-600">10:00</span>
                        </div>
                        <div class="flex space-x-2 md:space-x-4">
                            <button id="pause-btn" class="px-4 py-2 bg-yellow-500 text-white font-semibold rounded-lg hover:bg-yellow-600 transition-colors">‚è∏ Pause</button>
                            <button id="stop-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors">üõë End Session</button>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-lg p-6 shadow-inner flex flex-col space-y-4" style="height: 60vh; overflow-y: auto;" id="chat-container"></div>
                <div class="mt-4 flex justify-center space-x-4">
                    <button id="done-speaking-btn" class="px-6 py-3 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition-colors">‚úã I'm Done Speaking</button>
                    <button id="mute-btn" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors">üîá Mute AI</button>
                    <button id="repeat-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">üîÑ Repeat Last</button>
                </div>
            </div>

            <div id="report-area" class="hidden p-6 md:p-8">
                <div class="bg-white rounded-lg shadow-xl border p-8">
                    <div id="report-content" class="report-section"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURATION AND STATE MANAGEMENT ---
            
            const config = {
                productCategory: 'hair-replacement-systems',
                difficultyLevel: 'basic',
                salespersonName: '',
                sessionDuration: 10,
                knowledgeBase: 'ahl',
                apiKey: '', // OpenRouter API key - user must provide
                openAiApiKey: '', // OpenAI API key for embeddings - user must provide
                thinkingTime: 3000,
                pineconeApiKey: 'pcsk_7FLGMf_3A2Pb2YtvFphqmQqYa1dKuwP7eiKePEGjoqW3WsTSJjtEGfHH2go5NsovDUo9pn',
                pineconeEnvironment: 'us-east-1',
                pineconeIndexName: 'ahl-sales-training',
                apiKeyValid: false
            };

            const sessionState = {
                isActive: false,
                isPaused: false,
                isAISpeaking: false,
                startTime: null,
                conversationHistory: [],
                timeRemaining: 0,
                timerInterval: null,
                isMuted: false,
                recognition: null,
                recognitionActive: false,
                lastAIMessage: '',
                speechTimeout: null,
                currentTranscript: '',
                isWrappingUp: false
            };

            // DOM Elements Cache
            const elements = {
                mainContent: document.getElementById('main-content'),
                configPanel: document.getElementById('config-panel'),
                trainingArea: document.getElementById('training-area'),
                reportArea: document.getElementById('report-area'),
                startBtn: document.getElementById('start-btn'),
                stopBtn: document.getElementById('stop-btn'),
                pauseBtn: document.getElementById('pause-btn'),
                muteBtn: document.getElementById('mute-btn'),
                repeatBtn: document.getElementById('repeat-btn'),
                doneSpeakingBtn: document.getElementById('done-speaking-btn'),
                chatContainer: document.getElementById('chat-container'),
                sessionTimer: document.getElementById('session-timer'),
                statusIndicator: document.getElementById('status-indicator'),
                productCategory: document.getElementById('product-category'),
                difficultyLevel: document.getElementById('difficulty-level'),
                difficultyInfo: document.getElementById('difficulty-info'),
                salespersonName: document.getElementById('salesperson-name'),
                sessionDuration: document.getElementById('session-duration'),
                thinkingTime: document.getElementById('thinking-time'),
                reportContent: document.getElementById('report-content'),
                apiKeyInput: document.getElementById('api-key-input'),
                openAiApiKeyInput: document.getElementById('openai-api-key-input'),
                apiKeyStatus: document.getElementById('api-key-status'),
                testApiBtn: document.getElementById('test-api-btn')
            };

            // --- DATA: PERSONAS, PRODUCTS, AND KNOWLEDGE BASES ---

            const difficultyPersonas = {
                'new-joining': { name: 'Finn', traits: 'Friendly, interested, and new to this topic.', behavior: 'Asks basic questions and is generally agreeable. Has very few objections. Good for practicing the initial pitch.' },
                'basic': { name: 'Chloe', traits: 'Cautious and practical. Has done some initial research.', behavior: 'Asks common questions about price, quality, and durability. Will raise one or two standard objections that need to be addressed.' },
                'experienced': { name: 'Sam', traits: 'Skeptical and detail-oriented. May have had a bad experience in the past.', behavior: 'Questions specific claims, asks for proof or guarantees, and compares your solution to competitors they know about.' },
                'expert': { name: 'Alex', traits: 'An executive decision-maker who is highly knowledgeable and time-conscious.', behavior: 'Is impatient, cuts to the chase, challenges the core value proposition, and needs to be convinced of the ROI. Will test the depth of your knowledge.' }
            };

            const productCategories = {
                'hair-replacement-systems': { products: ['Custom Hair Replacement System', 'Ready-to-Wear Hair System', 'Thinnest Base System (2-4 months)', 'Thin Base System (4-6 months)', 'Thick Base System (8-12 months)'], context: 'non-surgical hair replacement solutions', price_range: '‚Çπ28,000-‚Çπ58,000', details: 'Made with highest quality human double drawn remy hair, customizable density, color, texture, base type and size' },
                'attachment-methods': { products: ['Clip-On Hair System', 'Stick-On Hair System (Glue/Tape)', 'Combination Method System', 'Daily Wear Systems'], context: 'hair system attachment solutions', price_range: '‚Çπ28,000-‚Çπ58,000', details: 'Different attachment methods for various lifestyle needs, from temporary clip-ons to secure adhesive systems' },
                'hair-transplant': { products: ['FUE Hair Transplant', 'FUT Hair Transplant', 'Donor Area Assessment', 'Post-Surgery Care'], context: 'surgical hair restoration', price_range: '‚Çπ50,000-‚Çπ2,50,000', details: 'Surgical procedure where hair from donor areas is grafted to thinning/balding areas, requires sufficient donor hair' },
                'scalp-micro-pigmentation': { products: ['SMP Full Head Treatment', 'SMP Hairline Enhancement', 'SMP Density Illusion', 'SMP Touch-up Sessions'], context: 'scalp micro pigmentation services', price_range: '‚Çπ35,000-‚Çπ75,000', details: 'Medical pigments applied to replicate thicker hair appearance, suitable for all skin types and colors' },
                'customization-services': { products: ['U.N.L. 21 Framework Custom System', 'Density Customization', 'Hair Color Matching', 'Texture Customization', 'Base Shape Design', 'Hairline Design'], context: 'fully customized hair solutions', price_range: '‚Çπ45,000-‚Çπ58,000', details: '21-point customization including density, color, texture, base material, hairline shape, implant direction' },
                'maintenance-services': { products: ['System Removal & Cleaning', 'Scalp Cleaning Service', 'Reattachment Service', 'Hair System Styling', 'Regular Maintenance Package'], context: 'hair system maintenance and care', price_range: '‚Çπ2,000-‚Çπ8,000 per session', details: 'Professional maintenance services including removal, cleaning, reattachment, and styling' },
                'consultation-services': { products: ['Video Consultation', 'In-Person Consultation', 'Partner Clinic Consultation', 'Home Measurement Service', 'Expert Assessment'], context: 'professional consultation services', price_range: '‚Çπ499 (refundable)', details: 'Comprehensive consultation to determine best hair solution, measurements, and personalized recommendations' }
            };
            
            const vectorKnowledgeBases = {
                'ahl': {
                    name: 'American Hairline Methodology',
                    query: 'Core principles of the American Hairline sales methodology',
                    data: [
                        "Principle 1: Always start by building rapport and asking about the client's personal hair loss journey to show empathy.",
                        "Principle 2: When discussing price, anchor it against the value of renewed confidence. Frame the U.N.L. 21 Framework as a premium, life-changing investment, not a cost.",
                        "Principle 3: Leverage the Shark Tank India story and celebrity endorsements early to build immediate credibility and dismantle skepticism.",
                        "Principle 4: Sell the transformation, not the product. Ask discovery questions like 'How would getting your hair back change your daily life or career?'",
                        "Principle 5: Address the 'natural look' objection by explaining the double drawn remy hair quality and the undetectable hairline design of the U.N.L. 21 system."
                    ]
                }
            };

            // --- IMPROVED API FUNCTIONS WITH BETTER ERROR HANDLING ---

            function isHtmlResponse(text) {
                return text.trim().toLowerCase().startsWith('<!doctype') || 
                       text.trim().toLowerCase().startsWith('<html');
            }

            async function createEmbedding(text, apiKey = null) {
                const openAiKey = apiKey || config.openAiApiKey;
                if (!openAiKey) {
                    throw new Error('OpenAI API key not provided');
                }
                
                try {
                    const response = await fetch('https://api.openai.com/v1/embeddings', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json', 
                            'Authorization': `Bearer ${openAiKey}`
                        },
                        body: JSON.stringify({ 
                            model: 'text-embedding-ada-002', 
                            input: text 
                        })
                    });
                    
                    const responseText = await response.text();
                    
                    if (!response.ok) {
                        if (isHtmlResponse(responseText)) {
                            throw new Error('API returned HTML error page - likely authentication or billing issue');
                        }
                        throw new Error(`Embedding API Error: ${response.status}. Response: ${responseText}`);
                    }
                    
                    if (isHtmlResponse(responseText)) {
                        throw new Error('API returned HTML instead of JSON - check your API key and account status');
                    }
                    
                    const data = JSON.parse(responseText);
                    if (!data.data || !data.data[0] || !data.data[0].embedding) {
                        throw new Error('Invalid embedding response format');
                    }
                    
                    return data.data[0].embedding;
                } catch (error) {
                    console.error('Error creating embedding:', error);
                    throw error;
                }
            }

            async function queryPinecone(embedding, topK = 5) {
                try {
                    const response = await fetch(`https://ahl-sales-training-6od5w6g.svc.aped-4627-b74a.pinecone.io/query`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json', 
                            'Api-Key': config.pineconeApiKey 
                        },
                        body: JSON.stringify({ 
                            vector: embedding, 
                            topK: topK, 
                            includeMetadata: true 
                        })
                    });
                    
                    const responseText = await response.text();
                    
                    if (!response.ok) {
                        throw new Error(`Pinecone API Error: ${response.status}. Response: ${responseText}`);
                    }
                    
                    const data = JSON.parse(responseText);
                    return data.matches;
                } catch (error) {
                    console.error('Error querying Pinecone:', error);
                    throw error;
                }
            }
            
            async function getContextFromVectorDB(queryText) {
                try {
                    console.log(`Querying Pinecone for: "${queryText}"`);
                    const embedding = await createEmbedding(queryText);
                    const matches = await queryPinecone(embedding);
                    if (matches && matches.length > 0) {
                        const contextChunks = matches.filter(match => match.score > 0.7).map(match => match.metadata?.text || 'No content available').join('\n\n');
                        console.log(`Retrieved ${matches.length} relevant chunks from Pinecone.`);
                        return contextChunks || 'No relevant context found in knowledge base.';
                    } else {
                        console.log('No matches found in Pinecone, using fallback data.');
                        return vectorKnowledgeBases.ahl.data.join('\n');
                    }
                } catch (error) {
                    console.error('Error getting context from vector DB:', error);
                    console.log('Falling back to default knowledge base data.');
                    return vectorKnowledgeBases[config.knowledgeBase]?.data?.join('\n') || 'Knowledge base unavailable.';
                }
            }

            // --- API KEY TESTING AND VALIDATION ---

            async function testApiKey(apiKey) {
                try {
                    const response = await fetch('https://openrouter.ai/api/v1/models', {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'HTTP-Referer': window.location.origin,
                            'X-Title': 'American Hairline Sales Trainer'
                        }
                    });

                    const responseText = await response.text();
                    
                    if (!response.ok) {
                        if (isHtmlResponse(responseText)) {
                            return { valid: false, error: 'Invalid API key or account issue' };
                        }
                        return { valid: false, error: `HTTP ${response.status}: ${responseText}` };
                    }

                    if (isHtmlResponse(responseText)) {
                        return { valid: false, error: 'API key appears invalid - received HTML instead of JSON' };
                    }

                    // If we get here, the API key is working
                    return { valid: true, error: null };
                } catch (error) {
                    return { valid: false, error: error.message };
                }
            }

            function updateApiKeyStatus(isValid, message = '') {
                const statusElement = elements.apiKeyStatus;
                const inputElement = elements.apiKeyInput;
                const openAiInputElement = elements.openAiApiKeyInput;
                
                statusElement.classList.remove('hidden');
                
                if (isValid) {
                    statusElement.textContent = message || '‚úÖ Both API keys are valid';
                    statusElement.className = 'mt-2 text-sm text-green-600';
                    inputElement.classList.remove('api-key-invalid');
                    inputElement.classList.add('api-key-valid');
                    openAiInputElement.classList.remove('api-key-invalid');
                    openAiInputElement.classList.add('api-key-valid');
                    elements.startBtn.disabled = false;
                    config.apiKeyValid = true;
                } else {
                    statusElement.textContent = `‚ùå ${message}`;
                    statusElement.className = 'mt-2 text-sm text-red-600';
                    inputElement.classList.remove('api-key-valid');
                    inputElement.classList.add('api-key-invalid');
                    openAiInputElement.classList.remove('api-key-valid');
                    openAiInputElement.classList.add('api-key-invalid');
                    elements.startBtn.disabled = true;
                    config.apiKeyValid = false;
                }
            }

            // --- IMPROVED OPENROUTER CALL WITH BETTER ERROR HANDLING ---

            async function callOpenRouter(messages, systemPromptContent) {
                if (!config.apiKey || !config.apiKeyValid) {
                    showError('Please provide and test a valid API key first.');
                    return null;
                }

                updateStatus('AI Thinking...', 'bg-yellow-400', true);
                try {
                    const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json', 
                            'Authorization': `Bearer ${config.apiKey}`,
                            'HTTP-Referer': window.location.origin,
                            'X-Title': 'American Hairline Sales Trainer'
                        },
                        body: JSON.stringify({
                            model: 'openai/gpt-4o',
                            messages: [{ role: 'system', content: systemPromptContent }, ...messages],
                            temperature: 0.7,
                            max_tokens: 10000
                        })
                    });
                    
                    const responseText = await response.text();
                    
                    if (!response.ok) {
                        if (isHtmlResponse(responseText)) {
                            throw new Error('API returned HTML error page - likely authentication or billing issue');
                        }
                        let structuredError = `API Error: ${response.status}`;
                        try {
                            const errorJson = JSON.parse(responseText);
                            structuredError = errorJson.error?.message || structuredError;
                        } catch (e) {
                            structuredError += ` - Response: ${responseText.substring(0, 200)}...`;
                        }
                        throw new Error(structuredError);
                    }
                    
                    if (isHtmlResponse(responseText)) {
                        throw new Error('API returned HTML instead of JSON - check your API key and account status');
                    }
                    
                    const data = JSON.parse(responseText);
                    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                        throw new Error('Invalid response format from OpenRouter API');
                    }
                    
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error('OpenRouter API Error:', error);
                    showError(`API Error: ${error.message}. Please check your OpenRouter API key and account status.`);
                    endSession(true);
                    return null;
                }
            }
            
            // --- CORE LOGIC: SPEECH, API, SESSION MANAGEMENT ---

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            const synthesis = window.speechSynthesis;

            function initializeSpeechRecognition() {
                if (!SpeechRecognition) { 
                    showError("Speech Recognition not supported. Please use Chrome or Edge."); 
                    return false; 
                }
                sessionState.recognition = new SpeechRecognition();
                sessionState.recognition.continuous = true;
                sessionState.recognition.interimResults = true;
                sessionState.recognition.lang = 'en-US';
                sessionState.recognition.onresult = handleSpeechResult;
                sessionState.recognition.onerror = handleSpeechError;
                sessionState.recognition.onend = handleSpeechEnd;
                return true;
            }

            function handleSpeechResult(event) {
                if (!sessionState.isActive || sessionState.isPaused || sessionState.isAISpeaking) return;
                if (sessionState.speechTimeout) clearTimeout(sessionState.speechTimeout);
                let interim_transcript = '';
                let final_transcript = sessionState.currentTranscript;
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) { 
                        final_transcript += event.results[i][0].transcript; 
                    } else { 
                        interim_transcript += event.results[i][0].transcript; 
                    }
                }
                sessionState.currentTranscript = final_transcript;
                sessionState.speechTimeout = setTimeout(() => {
                    const fullTranscript = (sessionState.currentTranscript + interim_transcript).trim();
                    if (fullTranscript) { processUserInput(fullTranscript); }
                    sessionState.currentTranscript = '';
                }, config.thinkingTime);
            }

            function handleSpeechError(event) {
                if (event.error === 'no-speech') {
                    // Silently handle no-speech errors - they're normal when user isn't speaking
                    return;
                }
                
                console.error('Speech recognition error:', event.error);
                if (event.error === 'not-allowed') {
                    showError('Microphone permission was denied. Please allow microphone access and refresh.');
                    endSession(true);
                } else {
                    showError(`An error occurred with speech recognition: ${event.error}`);
                }
            }
            
            function handleSpeechEnd() {
                sessionState.recognitionActive = false;
                if (sessionState.isActive && !sessionState.isPaused && !sessionState.isAISpeaking) { 
                    startListening(); 
                } else { 
                    updateStatus('Inactive', 'bg-gray-400'); 
                }
            }

            function startListening() {
                if (!sessionState.recognition || !sessionState.isActive || sessionState.recognitionActive || sessionState.isAISpeaking) {
                    return;
                }
                try {
                    sessionState.currentTranscript = '';
                    sessionState.recognition.start();
                    sessionState.recognitionActive = true;
                    updateStatus('Listening...', 'bg-blue-500', false);
                } catch (e) {
                    console.error("Error starting recognition:", e);
                    sessionState.recognitionActive = false;
                }
            }

            function stopListening() {
                if (sessionState.recognition && sessionState.recognitionActive) {
                    sessionState.recognition.stop();
                    sessionState.recognitionActive = false;
                }
                if (sessionState.speechTimeout) clearTimeout(sessionState.speechTimeout);
            }
            
            async function generateSystemPrompt(type, methodologyContext = '') {
                const product = productCategories[config.productCategory];
                
                if (type === 'conversation') {
                    const persona = difficultyPersonas[config.difficultyLevel];
                    return `You are an AI role-playing as ${persona.name}, a potential customer for American Hairline.
                    **Your Character Profile:** Name: ${persona.name}, Traits: ${persona.traits}, Behavior: ${persona.behavior}
                    **Product/Service of Interest:** ${product.context}
                    **Your Task:** Stay in character. Your responses should be conversational, realistic, and concise (1-3 sentences). Do NOT break character. Begin the conversation by stating your initial interest.`;
                }

                if (type === 'report') {
                    const knowledgeBaseName = vectorKnowledgeBases[config.knowledgeBase].name;
                    return `You are an expert sales coach. Your analysis MUST be based ONLY on the provided conversation transcript and the following sales methodology.

                    **Proprietary Sales Methodology: ${knowledgeBaseName}**
---
${methodologyContext}
---

**Your Task:**
Generate a comprehensive performance report in HTML format.

**Report Generation Rules:**
1.  **HTML ONLY:** Your entire response must be raw HTML. Do not use markdown or backticks like \`\`\`html.
2.  **Full Transcript First:** The very first section of your report must be "Full Conversation Transcript & Analysis". Reconstruct the entire conversation from the provided messages.
3.  **Analyze Every Salesperson Response:** After each response from the Salesperson, you MUST add a "Coach's Note". This note must include a numerical score (e.g., Score: <span class="score">8/10</span>).
4.  **Provide Alternatives:** If a Salesperson's response scores low (below 6/10), you MUST provide a "Suggested Alternative" response that better follows the sales methodology.
5.  **Strict Scoring:** You must assign a numerical score (out of 10) for ALL other sections and subsections as specified in the format below. Be strict and justify scores with specific examples.
6.  **Use Provided Names:** The customer's name is ${difficultyPersonas[config.difficultyLevel].name}. The salesperson's name is ${config.salespersonName}. Use these names in the transcript.

**Required Report Format (Follow This Structure Precisely):**

<h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">üìä Sales Performance Report</h2>

<h3>Full Conversation Transcript & Analysis</h3>
<div class="space-y-4 p-4 border rounded-lg bg-gray-50 mb-6">
    <div class="transcript-entry">
        <p><strong>Customer (${difficultyPersonas[config.difficultyLevel].name}):</strong> "The customer's full dialogue goes here."</p>
    </div>
    <div class="transcript-entry">
        <p><strong>Salesperson (${config.salespersonName}):</strong> "The salesperson's full dialogue goes here."</p>
        <div class="mt-2 p-2 bg-green-100 border-l-4 border-green-500 text-sm">
            <strong>Coach's Note (Score: <span class="score">9/10</span>):</strong> Justification for the high score.
        </div>
    </div>
    <div class="transcript-entry">
        <p><strong>Salesperson (${config.salespersonName}):</strong> "A different, weaker dialogue from the salesperson."</p>
        <div class="mt-2 p-2 bg-red-100 border-l-4 border-red-500 text-sm">
            <strong>Coach's Note (Score: <span class="score">3/10</span>):</strong> Justification for the low score.
            <p class="mt-2 font-semibold">Suggested Alternative:</p>
            <p class="italic">"A much better response that aligns with the methodology."</p>
        </div>
    </div>
    </div>

<div class="text-center mb-6">
    <h3 class="text-xl font-semibold">Overall Performance Score: <span class="score">__/10</span></h3>
</div>

<h3>Executive Summary <span class="score"> (Score: __/10)</span></h3>
<ul><li>Provide a brief overview of the performance, justifying the score.</li></ul>

<h3>Knowledge Analysis <span class="score"> (Overall Score: __/10)</span></h3>
<ul>
    <li><strong>Coverage (Score: <span class="score">__/10</span>):</strong> Breakdown what key information was covered or missed.</li>
    <li><strong>Acknowledgment (Score: <span class="score">__/10</span>):</strong> Assess how well the customer's needs were acknowledged.</li>
    <li><strong>Objection Handling (Score: <span class="score">__/10</span>):</strong> Evaluate effectiveness in handling objections based on the methodology.</li>
</ul>

<h3>Proficiency & Style Analysis <span class="score"> (Overall Score: __/10)</span></h3>
<ul>
    <li><strong>Clarity (Score: <span class="score">__/10</span>):</strong> How comprehensive and easy to understand was the speech?</li>
    <li><strong>Pace (Score: <span class="score">__/10</span>):</strong> Was the speaking tempo optimal?</li>
    <li><strong>Filler Words (Score: <span class="score">__/10</span>):</strong> How well were filler words avoided? (Score is high if few were used).</li>
    <li><strong>Energy (Score: <span class="score">__/10</span>):</strong> Did the language convey confidence and positive energy?</li>
    <li><strong>Sentence Structure (Score: <span class="score">__/10</span>):</strong> Were sentences varied and persuasive?</li>
</ul>

<h3>Adherence to Methodology <span class="score">(Score: __/10)</span></h3>
<p>This score reflects how consistently the principles of the ${knowledgeBaseName} were applied.</p>
<ul>
    <li><strong>Strengths:</strong><ul><li>List specific examples where methodology was successfully applied.</li></ul></li>
    <li><strong>Areas for Improvement:</strong><ul><li>List specific examples where methodology was missed.</li></ul></li>
</ul>

<h3>Actionable Recommendations</h3>
<ul><li>Provide clear, actionable steps for improvement based on the low-scoring areas.</li></ul>`;
                }

                if (type === 'wrapup') {
                    const persona = difficultyPersonas[config.difficultyLevel];
                    return `You are an AI role-playing as ${persona.name}, a potential customer for American Hairline.
                    **Your Character Profile:** Name: ${persona.name}, Traits: ${persona.traits}, Behavior: ${persona.behavior}
                    **Product/Service of Interest:** ${product.context}
                    
                    **IMPORTANT: The conversation time is almost up (less than 2 minutes remaining).**
                    
                    **Your Task:** Stay in character but begin naturally wrapping up the conversation. You should:
                    1. Acknowledge the time constraint if appropriate
                    2. Summarize your interest level or decision
                    3. Ask any final important questions
                    4. Provide clear next steps or indicate your decision
                    5. Keep responses conversational and realistic (1-3 sentences)
                    
                    Do NOT abruptly end the conversation, but guide it toward a natural conclusion within the next 1-2 exchanges.`;
                }
            }
            
            async function processUserInput(text) {
                if (!text.trim() || sessionState.isAISpeaking) return;
                stopListening();
                addMessage(text, 'user');
                sessionState.conversationHistory.push({ role: 'user', content: text });
                
                let systemPrompt;
                if (sessionState.isWrappingUp) {
                    systemPrompt = await generateSystemPrompt('wrapup');
                } else {
                    systemPrompt = await generateSystemPrompt('conversation');
                }
                
                const response = await callOpenRouter(sessionState.conversationHistory, systemPrompt);
                if (response) {
                    addMessage(response, 'ai');
                    sessionState.conversationHistory.push({ role: 'assistant', content: response });
                    speak(response);
                } else {
                    startListening();
                }
            }

            async function wrapUpConversation() {
                if (!sessionState.isActive) return;
                updateStatus('AI Wrapping Up...', 'bg-orange-500', true);
                
                const wrapUpPrompt = await generateSystemPrompt('wrapup');
                const response = await callOpenRouter(sessionState.conversationHistory, wrapUpPrompt);
                if (response) {
                    addMessage(response, 'ai');
                    sessionState.conversationHistory.push({ role: 'assistant', content: response });
                    speak(response);
                }
            }

            function speak(text) {
                if (sessionState.isMuted || !text) return;
                sessionState.isAISpeaking = true;
                sessionState.lastAIMessage = text;
                updateStatus('AI Speaking...', 'bg-green-500', false);
                synthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.95;
                utterance.pitch = 1.0;
                utterance.onend = () => {
                    sessionState.isAISpeaking = false;
                    if (sessionState.isActive && !sessionState.isPaused) { startListening(); }
                };
                utterance.onerror = (event) => {
                    console.error('Speech synthesis error:', event.error);
                    sessionState.isAISpeaking = false;
                    if (sessionState.isActive && !sessionState.isPaused) { startListening(); }
                };
                synthesis.speak(utterance);
            }

            // --- UI AND DISPLAY FUNCTIONS ---

            function updateStatus(text, colorClass, pulse = false) {
                const dot = elements.statusIndicator.querySelector('div');
                const label = elements.statusIndicator.querySelector('span');
                dot.className = `w-3 h-3 rounded-full ${colorClass} ${pulse ? 'animate-pulse' : ''}`;
                label.textContent = text;
            }

            function addMessage(text, sender) {
                const message = document.createElement('div');
                message.className = `chat-bubble ${sender === 'user' ? 'chat-bubble-user self-end' : 'chat-bubble-ai self-start'}`;
                message.textContent = text;
                elements.chatContainer.appendChild(message);
                elements.chatContainer.scrollTop = elements.chatContainer.scrollHeight;
            }
            
            function showError(message) {
                const existingModal = document.querySelector('.error-modal-overlay');
                if (existingModal) existingModal.remove();
                const modal = document.createElement('div');
                modal.className = 'modal-overlay error-modal-overlay';
                modal.innerHTML = `
                    <div class="modal-content">
                        <h2 class="text-xl font-bold mb-4 text-red-600">‚ö†Ô∏è An Error Occurred</h2>
                        <p class="text-gray-700 mb-6">${message}</p>
                        <button class="w-full px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700" onclick="this.closest('.modal-overlay').remove()">Close</button>
                    </div>`;
                document.body.appendChild(modal);
            }

            function updateDifficultyInfo() {
                const selectedLevel = elements.difficultyLevel.value;
                const personaInfo = difficultyPersonas[selectedLevel];
                if (personaInfo) {
                    elements.difficultyInfo.innerHTML = `
                        <p class="text-xs text-gray-700 leading-tight">
                            <strong>AI Persona: ${personaInfo.name}</strong><br>
                            ${personaInfo.behavior}
                        </p>
                    `;
                }
            }

            // --- TIMER FUNCTIONS ---
            
            function startTimer() {
                sessionState.timeRemaining = config.sessionDuration * 60;
                updateTimerDisplay();
                sessionState.timerInterval = setInterval(() => {
                    if (!sessionState.isPaused && sessionState.isActive) {
                        sessionState.timeRemaining--;
                        updateTimerDisplay();
                        
                        // When 2 minutes remaining, AI should start wrapping up
                        if (sessionState.timeRemaining === 120 && !sessionState.isWrappingUp) {
                            sessionState.isWrappingUp = true;
                            wrapUpConversation();
                        }
                        
                        if (sessionState.timeRemaining <= 0) { 
                            endSession(); 
                        }
                    }
                }, 1000);
            }

            function updateTimerDisplay() {
                const minutes = Math.floor(sessionState.timeRemaining / 60);
                const seconds = sessionState.timeRemaining % 60;
                elements.sessionTimer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                elements.sessionTimer.classList.toggle('text-red-600', sessionState.timeRemaining <= 60);
            }

            // --- SESSION FLOW: START, PAUSE, END ---

            async function startSession() {
                if (!config.apiKeyValid) {
                    showError('Please provide and test a valid API key before starting.');
                    return;
                }
                
                if (!elements.salespersonName.value.trim()) { 
                    showError('Please enter the salesperson name to begin.'); 
                    return; 
                }
                
                try {
                    await navigator.mediaDevices.getUserMedia({ audio: true });
                } catch (err) {
                    showError('Microphone access is required. Please allow it in your browser and try again.');
                    return;
                }
                
                Object.assign(config, {
                    productCategory: elements.productCategory.value,
                    difficultyLevel: elements.difficultyLevel.value, 
                    salespersonName: elements.salespersonName.value.trim(), 
                    sessionDuration: parseInt(elements.sessionDuration.value),
                    thinkingTime: parseInt(elements.thinkingTime.value)
                });
                
                Object.assign(sessionState, {
                    isActive: true, 
                    isPaused: false, 
                    isAISpeaking: false,
                    conversationHistory: [], 
                    startTime: new Date(),
                    isWrappingUp: false
                });
                
                elements.configPanel.classList.add('hidden');
                elements.reportArea.classList.add('hidden');
                elements.trainingArea.classList.remove('hidden');
                elements.chatContainer.innerHTML = '';
                startTimer();
                updateStatus('Initializing AI...', 'bg-blue-400', true);
                
                const systemPrompt = await generateSystemPrompt('conversation');
                const initialMessage = await callOpenRouter([], systemPrompt);
                if (initialMessage && sessionState.isActive) {
                    addMessage(initialMessage, 'ai');
                    sessionState.conversationHistory.push({ role: 'assistant', content: initialMessage });
                    speak(initialMessage);
                }
            }

            async function endSession(skipReport = false) {
                if (!sessionState.isActive) return;
                sessionState.isActive = false;
                stopListening();
                synthesis.cancel();
                if (sessionState.timerInterval) clearInterval(sessionState.timerInterval);
                
                if (skipReport || sessionState.conversationHistory.length < 2) {
                    elements.trainingArea.classList.add('hidden');
                    elements.reportArea.classList.remove('hidden');
                    elements.reportContent.innerHTML = `
                        <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">üìä Sales Performance Report</h2>
                        <p class="text-center text-lg">Session was too brief to generate a report.</p>
                        <div class="mt-8 text-center">
                            <button id="new-session-btn" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700">üîÑ Start New Session</button>
                        </div>`;
                    document.getElementById('new-session-btn').addEventListener('click', resetToConfig);
                    updateStatus('Session Ended', 'bg-gray-500');
                    return;
                }
                
                updateStatus('Generating Report...', 'bg-purple-500', true);
                elements.trainingArea.classList.add('hidden');
                elements.reportArea.classList.remove('hidden');
                elements.reportContent.innerHTML = '<p class="text-center">üîç Analyzing conversation and retrieving knowledge base...</p>';
                
                try {
                    const knowledgeQuery = vectorKnowledgeBases[config.knowledgeBase].query;
                    const methodologyContext = await getContextFromVectorDB(knowledgeQuery);
                    const reportSystemPrompt = await generateSystemPrompt('report', methodologyContext);
                    const reportHtml = await callOpenRouter(sessionState.conversationHistory, reportSystemPrompt);
                    
                    if (reportHtml) {
                        const selectedDifficultyText = elements.difficultyLevel.options[elements.difficultyLevel.selectedIndex].text;
                        const finalReportHtml = `
                            ${reportHtml}
                            <div class="mt-8 p-6 bg-gray-50 rounded-lg border">
                                <h3>Session Details</h3>
                                <div class="grid grid-cols-2 gap-4 text-sm mt-4">
                                    <div><strong>Salesperson:</strong> ${config.salespersonName}</div>
                                    <div><strong>Product Focus:</strong> ${productCategories[config.productCategory].context}</div>
                                    <div><strong>Knowledge Base:</strong> ${vectorKnowledgeBases[config.knowledgeBase].name}</div>
                                    <div><strong>Difficulty Level:</strong> ${selectedDifficultyText}</div>
                                    <div><strong>Date:</strong> ${sessionState.startTime.toLocaleDateString()}</div>
                                </div>
                            </div>
                            <div class="mt-8 text-center">
                                <button id="new-session-btn" class="px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700">üîÑ Start New Session</button>
                            </div>`;
                        elements.reportContent.innerHTML = finalReportHtml;
                        document.getElementById('new-session-btn').addEventListener('click', resetToConfig);
                    } else {
                        elements.reportContent.innerHTML = '<p class="text-center text-red-500">Could not generate the report due to an API error.</p>';
                    }
                } catch (error) {
                    console.error('Error generating report:', error);
                    elements.reportContent.innerHTML = '<p class="text-center text-red-500">An error occurred while generating the report. Please try again.</p>';
                }
                updateStatus('Session Complete', 'bg-green-500');
            }
            
            function pauseSession() {
                sessionState.isPaused = !sessionState.isPaused;
                elements.pauseBtn.innerHTML = sessionState.isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏ Pause';
                if (sessionState.isPaused) {
                    updateStatus('Paused', 'bg-yellow-500');
                    synthesis.cancel();
                    stopListening();
                } else {
                    updateStatus('Resuming...', 'bg-blue-400');
                    setTimeout(() => { if (!sessionState.isAISpeaking) startListening(); }, 500);
                }
            }
            
            function resetToConfig() {
                elements.reportArea.classList.add('hidden');
                elements.trainingArea.classList.add('hidden');
                elements.configPanel.classList.remove('hidden');
                updateStatus('Ready', 'bg-green-500');
            }

            // --- EVENT LISTENERS ---
            
            function setupEventListeners() {
                elements.startBtn.addEventListener('click', startSession);
                elements.stopBtn.addEventListener('click', () => endSession());
                elements.pauseBtn.addEventListener('click', pauseSession);
                elements.difficultyLevel.addEventListener('input', updateDifficultyInfo);
                
                // API Key testing
                elements.testApiBtn.addEventListener('click', async () => {
                    const apiKey = elements.apiKeyInput.value.trim();
                    const openAiApiKey = elements.openAiApiKeyInput.value.trim();
                    
                    if (!apiKey) {
                        updateApiKeyStatus(false, 'Please enter an OpenRouter API key');
                        return;
                    }
                    
                    if (!openAiApiKey) {
                        updateApiKeyStatus(false, 'Please enter an OpenAI API key');
                        return;
                    }
                    
                    elements.testApiBtn.disabled = true;
                    elements.testApiBtn.textContent = 'Testing...';
                    
                    // Test OpenRouter API
                    const openRouterResult = await testApiKey(apiKey);
                    
                    if (!openRouterResult.valid) {
                        updateApiKeyStatus(false, `OpenRouter API: ${openRouterResult.error}`);
                        elements.testApiBtn.disabled = false;
                        elements.testApiBtn.textContent = 'Test API Connection';
                        return;
                    }
                    
                    // Test OpenAI API by creating a simple embedding
                    try {
                        const testEmbedding = await createEmbedding('test', openAiApiKey);
                        if (testEmbedding && testEmbedding.length > 0) {
                            config.apiKey = apiKey;
                            config.openAiApiKey = openAiApiKey;
                            updateApiKeyStatus(true, 'Both API keys are valid');
                            updateStatus('Ready to Start', 'bg-green-500');
                        } else {
                            updateApiKeyStatus(false, 'OpenAI API key test failed');
                        }
                    } catch (error) {
                        updateApiKeyStatus(false, `OpenAI API: ${error.message}`);
                    }
                    
                    elements.testApiBtn.disabled = false;
                    elements.testApiBtn.textContent = 'Test API Connection';
                });

                // Auto-test API key on input change
                elements.apiKeyInput.addEventListener('input', () => {
                    config.apiKeyValid = false;
                    elements.startBtn.disabled = true;
                    elements.apiKeyStatus.classList.add('hidden');
                    elements.apiKeyInput.classList.remove('api-key-valid', 'api-key-invalid');
                });
                
                // Handle OpenAI API key input
                elements.openAiApiKeyInput.addEventListener('input', () => {
                    config.openAiApiKey = elements.openAiApiKeyInput.value.trim();
                    elements.openAiApiKeyInput.classList.remove('api-key-valid', 'api-key-invalid');
                });
                
                elements.muteBtn.addEventListener('click', () => {
                    sessionState.isMuted = !sessionState.isMuted;
                    elements.muteBtn.textContent = sessionState.isMuted ? 'üîä Unmute AI' : 'üîá Mute AI';
                    if (sessionState.isMuted) synthesis.cancel();
                });
                
                elements.repeatBtn.addEventListener('click', () => {
                    if (sessionState.lastAIMessage && !sessionState.isAISpeaking) { 
                        speak(sessionState.lastAIMessage); 
                    }
                });
                
                elements.doneSpeakingBtn.addEventListener('click', () => {
                    if (sessionState.speechTimeout) clearTimeout(sessionState.speechTimeout);
                    const fullTranscript = sessionState.currentTranscript.trim();
                    if (fullTranscript) { processUserInput(fullTranscript); }
                    sessionState.currentTranscript = '';
                });
            }

            // --- INITIALIZATION ---
            
            function initialize() {
                if (!SpeechRecognition || !synthesis) {
                    elements.mainContent.innerHTML = `<div class="p-8 text-center"><h2 class="text-2xl font-bold text-red-600 mb-4">Browser Not Supported</h2><p class="text-gray-700">Please use <strong class="text-black">Google Chrome</strong> or <strong class="text-black">Microsoft Edge</strong> on desktop.</p></div>`;
                    return;
                }
                if (!initializeSpeechRecognition()) return;
                
                updateDifficultyInfo();
                setupEventListeners();
                updateStatus('Waiting for API Key', 'bg-yellow-500');
            }

            initialize();
        });
    </script>
</body>
</html>
